name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run formatter check
        run: npm run format -- --check

  test-ts:
    name: TypeScript Tests & Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run TypeScript tests
        run: npm test

      - name: Build TypeScript
        run: npm run build

  build-ios:
    name: iOS Build
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: |
            ios/Pods
            ~/Library/Caches/CocoaPods
          key: ${{ runner.os }}-pods-${{ hashFiles('ios/LoqaAudioBridgeModule.podspec') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Create minimal Podfile for testing
        run: |
          cd ios
          cat > Podfile <<'EOF'
          platform :ios, '13.4'

          target 'LoqaAudioBridgeModule' do
            pod 'LoqaAudioBridgeModule', :path => '.'
          end
          EOF

      - name: Install CocoaPods dependencies
        run: |
          cd ios
          pod install --repo-update

      - name: Build iOS module with xcodebuild
        run: |
          cd ios
          # List available schemes
          xcodebuild -list -workspace LoqaAudioBridgeModule.xcworkspace || true

          # Build the pod
          xcodebuild \
            -workspace LoqaAudioBridgeModule.xcworkspace \
            -scheme Pods-LoqaAudioBridgeModule \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
            -configuration Release \
            clean build \
            CODE_SIGNING_ALLOWED=NO \
            | tee build.log

          # Check for warnings (fail if any found)
          if grep -q "warning:" build.log; then
            echo "‚ùå Build contains warnings"
            grep "warning:" build.log
            exit 1
          fi
          echo "‚úÖ Build completed with zero warnings"

  build-android:
    name: Android Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Install dependencies
        run: npm ci

      - name: Build Android module with Gradle
        run: |
          cd android
          ./gradlew clean build --warning-mode=all 2>&1 | tee build.log

          # Check for warnings (fail if any found)
          if grep -q "warning" build.log; then
            echo "‚ùå Build contains warnings"
            grep "warning" build.log
            exit 1
          fi
          echo "‚úÖ Build completed with zero warnings"

  validate-package:
    name: Package Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build package
        run: npm run build

      - name: Create npm package
        run: npm pack

      - name: Extract tarball
        run: |
          mkdir -p package-inspection
          tar -xzf loqalabs-loqa-audio-bridge-*.tgz -C package-inspection

      - name: Validate no test files in package
        run: |
          cd package-inspection/package

          echo "üîç Checking for test files..."

          # Check for TypeScript test files
          if find . -name "*.test.ts" -o -name "*.spec.ts" | grep .; then
            echo "‚ùå ERROR: TypeScript test files found in package!"
            exit 1
          fi

          # Check for Swift test files
          if find . -name "*Tests.swift" -o -name "*Test.swift" | grep .; then
            echo "‚ùå ERROR: Swift test files found in package!"
            exit 1
          fi

          # Check for Kotlin test files
          if find . -name "*Test.kt" -o -name "*Tests.kt" | grep .; then
            echo "‚ùå ERROR: Kotlin test files found in package!"
            exit 1
          fi

          echo "‚úÖ No test files found (TypeScript, Swift, Kotlin)"

      - name: Validate no test directories in package
        run: |
          cd package-inspection/package

          echo "üîç Checking for test directories..."

          # Check for common test directories
          if [ -d "__tests__" ]; then
            echo "‚ùå ERROR: __tests__/ directory found in package!"
            exit 1
          fi

          if [ -d "ios/Tests" ]; then
            echo "‚ùå ERROR: ios/Tests/ directory found in package!"
            exit 1
          fi

          if [ -d "android/src/test" ]; then
            echo "‚ùå ERROR: android/src/test/ directory found in package!"
            exit 1
          fi

          if [ -d "android/src/androidTest" ]; then
            echo "‚ùå ERROR: android/src/androidTest/ directory found in package!"
            exit 1
          fi

          if [ -d "example" ]; then
            echo "‚ùå ERROR: example/ directory found in package!"
            exit 1
          fi

          echo "‚úÖ No test directories found"

      - name: Validate package size
        run: |
          SIZE=$(ls -lh loqalabs-loqa-audio-bridge-*.tgz | awk '{print $5}')
          SIZE_BYTES=$(ls -l loqalabs-loqa-audio-bridge-*.tgz | awk '{print $5}')
          MAX_SIZE=$((500 * 1024))  # 500 KB in bytes

          echo "üì¶ Package size: $SIZE ($SIZE_BYTES bytes)"

          if [ "$SIZE_BYTES" -gt "$MAX_SIZE" ]; then
            echo "‚ö†Ô∏è WARNING: Package size exceeds 500 KB target"
          else
            echo "‚úÖ Package size within target (<500 KB)"
          fi

      - name: List package contents
        run: |
          echo "üìã Package contents:"
          tar -tzf loqalabs-loqa-audio-bridge-*.tgz | head -50
